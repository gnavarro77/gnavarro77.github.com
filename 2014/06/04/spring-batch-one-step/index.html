<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="description" content="Blog">
<meta name="author" content="Gilles Navarro">

<title>Spring Batch, Step One</title> 

<link rel="stylesheet"
	href="/assets/bower_components/bootstrap-css/css/bootstrap.css">
<link rel="stylesheet"
	href="/assets/bower_components/bootstrap-css/css/bootstrap-theme.css">
<link rel="stylesheet" href="/assets/css/solarized.css">
<link rel="stylesheet" href="/assets/theme/hellish-simplicity/style.css">

<script type="text/javascript"
		src="/assets/bower_components/jquery/dist/jquery.min.js"></script>

</head>
<body>

	<header id="site-header" role="banner">
		<div class="hgroup">
			<h1>De choses et d'autres</h1>
			<h2></h2>
		</div>
	</header>

	<div id="main" class="site-main">
		<div id="content-area">
			<div id="site-content" role="main"><article class="post type-post status-publish format-standard hentry category-uncategorized tag-boat tag-lake">
	<header class="entry-header">
		<h1 class="entry-title">Spring Batch, Step One </h1>
	</header>
	<div class="date">
      <span>04 June 2014</span>
    </div>
	<div class="entry-content">
		<p>In this post we are going to make a simple but very common type of batch.</p>

<h2 id="context">Context</h2>

<p>Let’s say we provide ours customers with consolidated NBA players statistics. Our staple food is statistics <br />
like those of the 2013-14 season of Tony Parker.</p>

<table>
  <thead>
    <tr>
      <th>Player</th>
      <th>Season</th>
      <th>GP</th>
      <th>MIN</th>
      <th>FGM</th>
      <th>FGA</th>
      <th>FG%</th>
      <th>3FGM</th>
      <th>3FGA</th>
      <th>3FG%</th>
      <th>FTM</th>
      <th>FTA</th>
      <th>FT%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Tony Parker</td>
      <td>2013-14</td>
      <td>68</td>
      <td>29.4</td>
      <td>6.7</td>
      <td>13.4</td>
      <td>49.9%</td>
      <td>0.4</td>
      <td>1.0</td>
      <td>37.3%</td>
      <td>2.9</td>
      <td>3.6</td>
      <td>81.1%</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>OREB</th>
      <th>DREB</th>
      <th>REB</th>
      <th>AST</th>
      <th>TOV</th>
      <th>STL</th>
      <th>BLK</th>
      <th>PF</th>
      <th>DD2</th>
      <th>TD3</th>
      <th>PTS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.3</td>
      <td>2.0</td>
      <td>2.3</td>
      <td>5.7</td>
      <td>2.2</td>
      <td>0.5</td>
      <td>0.1</td>
      <td>1.3</td>
      <td>2</td>
      <td>0</td>
      <td>16.7</td>
    </tr>
  </tbody>
</table>

<p>which gives us the flowing line in a delimited flat file :</p>

<pre><code>Tony Parker,2013-14,68,29.4,6.7,13.4,49.9%,0.4,1.0,37.3%,2.9,3.6,81.1%,0.3,2.0,2.3,5.7,2.2,0.5,0.1,1.3,2,0,16.7
</code></pre>

<p>For <strong>each line</strong> we want to update for the <strong>player</strong> and the <strong>season</strong> the <br />
average number of points per game (the last field).</p>

<h2 id="lets-get-started">Let’s get started!</h2>

<h4 id="naming">Naming</h4>

<p>First we need to find a name to our job; As the aim is to update the player’s average <br />
number of points per game on a season, let’s go for <code>AveragePointsPerGameUpdateJob</code>.</p>

<h4 id="unit-test-class">Unit Test Class</h4>

<p>We then create the unit test class <code>AveragePointsPerGameUpdateJobTest</code> </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">gnavarro77</span><span class="o">.</span><span class="na">blog</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">batch</span><span class="o">.</span><span class="na">step</span><span class="o">.</span><span class="na">one</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hamcrest</span><span class="o">.</span><span class="na">CoreMatchers</span><span class="o">.</span><span class="na">is</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">gnavarro77.blog.spring.batch.bean.StatisticBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.batch.item.ExecutionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.batch.item.ItemWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.batch.item.file.ResourceAwareItemReaderItemStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.batch.item.file.mapping.FieldSetMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.batch.item.file.transform.LineTokenizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ByteArrayResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AveragePointsPerGameUpdateJobTest</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * LineTokenizer is here to split a line into its atomic fields</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="n">LineTokenizer</span> <span class="n">tokenizer</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Out of a line i need to get the player name, the season and the average</span>
<span class="cm">	 * number of points per game.</span>
<span class="cm">	 */</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">tokenizeLineTest</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;Tony Parker,2013-14,68,29.4,6.7,13.4,49.9%,0.4,1.0,37.3%,2.9,3.6,81.1%,0.3,2.0,2.3,5.7,2.2,0.5,0.1,1.3,2,0,16.7&quot;</span><span class="o">;</span>
		<span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="na">tokenize</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">getProperties</span><span class="o">();</span>
		<span class="c1">// Here i made a choice on the way i get values out of the</span>
		<span class="c1">// LineTokenizer; Could have been otherwise</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;player&quot;</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Tony Parker&quot;</span><span class="o">));</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;season&quot;</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;2013-14&quot;</span><span class="o">));</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;appg&quot;</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;16.7&quot;</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * FieldSetMapper is here to make a line available as an instance of bean</span>
<span class="cm">	 * StatisticBean</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="n">FieldSetMapper</span><span class="o">&lt;</span><span class="n">StatisticBean</span><span class="o">&gt;</span> <span class="n">fieldSetMapper</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * We chose to map a line to a bean instance, it could have been otherwise</span>
<span class="cm">	 * </span>
<span class="cm">	 * @throws BindException</span>
<span class="cm">	 */</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">mapFieldSetTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">BindException</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;Tony Parker,2013-14,68,29.4,6.7,13.4,49.9%,0.4,1.0,37.3%,2.9,3.6,81.1%,0.3,2.0,2.3,5.7,2.2,0.5,0.1,1.3,2,0,16.7&quot;</span><span class="o">;</span>
		<span class="n">StatisticBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">fieldSetMapper</span><span class="o">.</span><span class="na">mapFieldSet</span><span class="o">(</span><span class="n">tokenizer</span>
				<span class="o">.</span><span class="na">tokenize</span><span class="o">(</span><span class="n">line</span><span class="o">));</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getPlayer</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Tony Parker&quot;</span><span class="o">));</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getSeason</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;2013-14&quot;</span><span class="o">));</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getAppg</span><span class="o">(),</span> <span class="n">is</span><span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="mf">16.7</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * We know that we read data out of a flat file that&#39;s why we go for a</span>
<span class="cm">	 * ResourceAwareItemReaderItemStream</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="n">ResourceAwareItemReaderItemStream</span><span class="o">&lt;</span><span class="n">StatisticBean</span><span class="o">&gt;</span> <span class="n">itemReader</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @throws Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">readTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;Tony Parker,2013-14,68,29.4,6.7,13.4,49.9%,0.4,1.0,37.3%,2.9,3.6,81.1%,0.3,2.0,2.3,5.7,2.2,0.5,0.1,1.3,2,0,16.7&quot;</span><span class="o">;</span>
		<span class="n">itemReader</span><span class="o">.</span><span class="na">setResource</span><span class="o">(</span><span class="k">new</span> <span class="nf">ByteArrayResource</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
		<span class="n">itemReader</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="nf">ExecutionContext</span><span class="o">());</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">StatisticBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">itemReader</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
			<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getPlayer</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Tony Parker&quot;</span><span class="o">));</span>
			<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getSeason</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;2013-14&quot;</span><span class="o">));</span>
			<span class="n">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getAppg</span><span class="o">(),</span> <span class="n">is</span><span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="mf">16.7</span><span class="o">));</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">itemReader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span>

	<span class="o">}</span>
	
	
	<span class="kd">private</span> <span class="n">ItemWriter</span><span class="o">&lt;</span><span class="n">StatisticBean</span><span class="o">&gt;</span> <span class="n">itemWriter</span><span class="o">;</span>

<span class="o">}</span></code></pre></div>

<hr />

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">gnavarro77</span><span class="o">.</span><span class="na">blog</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">batch</span><span class="o">.</span><span class="na">bean</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatisticBean</span> <span class="o">{</span>
	<span class="c1">// player&#39;s name</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">player</span><span class="o">;</span>
	<span class="c1">// season</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">season</span><span class="o">;</span>
	<span class="c1">// average points per game</span>
	<span class="kd">private</span> <span class="kt">float</span> <span class="n">appg</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getPlayer</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">player</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPlayer</span><span class="o">(</span><span class="n">String</span> <span class="n">player</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">player</span> <span class="o">=</span> <span class="n">player</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getSeason</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">season</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSeason</span><span class="o">(</span><span class="n">String</span> <span class="n">season</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">season</span> <span class="o">=</span> <span class="n">season</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">float</span> <span class="nf">getAppg</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">appg</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAppg</span><span class="o">(</span><span class="kt">float</span> <span class="n">appg</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">appg</span> <span class="o">=</span> <span class="n">appg</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></div>

<h3 id="maven">Maven</h3>
<p>We add a property :</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;spring-batch.version&gt;</span>3.0.0.RELEASE<span class="nt">&lt;/spring-batch.version&gt;</span></code></pre></div>

<p>and then a dependency :</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.batch<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-batch-core<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>${spring-batch.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></div>

<h3 id="test">Test</h3>

<p>We create a Unit Test Class <code>SimpleBatchTest</code>.</p>

<p>Mind to add <code>junit:junit:4.x</code> and <code>org.springframework:spring-test:2.5</code> to your maven dependencies.</p>


	</div>
	<footer class="entry-meta">
		
	</footer>
</article></div>
			<div id="sidebar" role="complementary">
<!-- 				<aside> -->
<!-- 					<h1 class="widget-title">Recent Posts</h1> -->
<!-- 					<ul> -->
<!-- 						<li><a href="https://wp-themes.com/?p=19" -->
<!-- 							title="Look Worth A Thousand Words">Worth A Thousand Words</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=36" -->
<!-- 							title="Look Elements">Elements</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=14" -->
<!-- 							title="Look More Tags">More Tags</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=8" title="Look HTML">HTML</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=6" title="Look Links">Links</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=4" -->
<!-- 							title="Look Category Hierarchy">Category Hierarchy</a></li> -->
<!-- 						<li><a href="https://wp-themes.com/?p=1" -->
<!-- 							title="Look Hello world!">Hello world!</a></li> -->
<!-- 					</ul> -->
<!-- 				</aside> -->
				<aside>
					<h1 class="widget-title">Archives</h1>
<ul class="list-unstyled">


  
  
  
  
  
  
    <li>
    	<a href="/2014/09/index.html">September 2014</a>
    </li>
     
  

  
  
  
  
  
  
    <li>
    	<a href="/2014/06/index.html">June 2014</a>
    </li>
     
  

  
  
  
  
  
  

  
  
  
  
  
  

  
  
  
  
  
  
    <li>
    	<a href="/2014/05/index.html">May 2014</a>
    </li>
     
  

  
</ul>


				</aside>
			</div>
		</div>
	</div>


</body>
</html>

